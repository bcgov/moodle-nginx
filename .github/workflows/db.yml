name: DB

concurrency:
  group: db-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  workflow_call:
    inputs:
      OPENSHIFT_DEPLOY_PROJECT:
        required: true
        type: string
      APP:
        required: true
        type: string
      DB_NAME:
        required: true
        type: string
      DB_USER:
        required: true
        type: string
      DB_PASSWORD:
        required: true
        type: string
      WEB_DEPLOYMENT_NAME:
        required: true
        type: string
      WEB_IMAGE:
        required: true
        type: string
      PHP_DEPLOYMENT_NAME:
        required: true
        type: string
      PHP_IMAGE:
        required: true
        type: string
      DB_DEPLOYMENT_NAME:
        required: true
        type: string
      DB_IMAGE:
        required: true
        type: string
      CRON_IMAGE:
        required: true
        type: string
      CRON_DEPLOYMENT_NAME:
        required: true
        type: string
      REDIS_REPO:
        required: true
        type: string
      REDIS_DEPLOYMENT_NAME:
        required: true
        type: string
      REDIS_IMAGE:
        required: true
        type: string
      APP_HOST_URL:
        required: true
        type: string
      BUILD_NAMESPACE:
        required: true
        type: string
      DEPLOY_NAMESPACE:
        required: true
        type: string
      IMAGE_REPO:
        required: true
        type: string
      BRANCH:
        required: true
        type: string
  # push:
  #   branches:
  #     - dev
  #     #- test
  #     #- prod
  #   paths:
  #     - '**/config/mariadb/**'
  #     - '**/workflows/**'
  #     - '**/**.env'
  # pull_request:
  #   branches:
  #     - dev
  #     #- test
  #     #- prod
  #   paths:
  #     - '**/config/mariadb/**'
  #     #- '**/workflows/build-push-db-image.yml'
  #     - '**/workflows/**'
  #     - '**/**.env'
jobs:

  # Build DB Image

  build-images:
    name: 'üî® Build'
    runs-on: ubuntu-latest
    #env:
      # Proxy settings for local development / testing
      #https_proxy: http://198.161.14.25:8080
      # no_proxy: ${{ env.OPENSHIFT_SERVER }}
    if: (github.ref_name == 'dev' || github.ref_name == 'test' || github.ref_name == 'prod')
    steps:
      - name: üì§ Checkout Target Branch
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config/mariadb
            example.env
            example.versions.env

      - name: Setup Env Vars
        id: dotenv
        uses: falti/dotenv-action@v1
        with:
          path: example.env
          export-variables: true
          keys-case: upper

      - name: Setup Env Version Vars
        id: dotenv_versions
        uses: falti/dotenv-action@v1
        with:
          path: example.versions.env
          export-variables: true
          keys-case: upper

      - name: Check Env Vars
        run: |
          echo Building and pushing DB_IMAGE: ${{ env.DB_IMAGE }}

      # Login to Artifactory
      - name: üîë Login to Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ARTIFACTORY_URL }}
          username: ${{ secrets.ARTIFACTORY_USER }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: üõ†Ô∏è Pull latest DB base image then push to Artifactory
        run: |
          docker pull ${{ env.DB_IMAGE }}
          docker tag ${{ env.DB_IMAGE }} ${{ secrets.ARTIFACTORY_URL }}/${{ env.DB_IMAGE }}
          docker push ${{ secrets.ARTIFACTORY_URL }}/${{ env.DB_IMAGE }}
